# 无人机自主跟踪系统

这是一个用于控制无人机自主飞行并进行路径规划和避障的系统。

## 功能特点

- 无人机基本控制：起飞、降落、返航、悬停等功能
- 连接管理：支持连接到实际无人机或使用模拟器
- 状态监控：实时显示无人机状态、GPS信息、电池信息等
- 轨迹规划：支持手动设置目标点，自动规划飞行路径
- 避障功能：智能检测和避开障碍物
- 地图显示：可视化显示无人机位置和航线

### 新增功能

- **障碍物管理界面**：专门的障碍物和路径显示标签页，可查看当前系统中的所有障碍物及规划路径
- **视频界面交互**：通过视频画面点击添加障碍物，更加直观
- **路径规划可视化**：在视频画面上直观显示规划路径和障碍物
- **智能避障**：自动绕过用户添加的障碍物，确保飞行安全

## 系统架构

系统由以下主要模块组成：

1. **主控模块** (`main.py`)：系统入口点，负责初始化和协调各个模块
2. **无人机控制** (`flight_control`):
   - `drone_controller.py`: 无人机基本控制接口，实现起飞、降落、导航等功能
   - `flight_monitor.py`: 监控无人机状态，包括电池、GPS和飞行姿态

3. **视觉模块** (`vision`):
   - `video_manager.py`: 管理视频输入流和录制功能
   - `depth_processor.py`: 处理深度信息，用于障碍物检测
   - `video_frame.py`: 视频界面组件，用于显示和交互

4. **导航模块** (`navigation`):
   - `path_planner.py`: 实现路径规划算法，包括RRT（快速扩展随机树）和路径平滑功能

5. **图形界面** (`gui`):
   - `main_window.py`: 主窗口界面，集成各个功能模块
   - `video_frame.py`: 视频显示和控制组件

6. **工具类** (`utils`):
   - 日志、配置、GPS计算等辅助功能

## 系统工作流程

1. **初始化阶段**:
   - 加载配置文件
   - 初始化各个功能模块
   - 创建用户界面

2. **连接阶段**:
   - 用户可选择连接实际无人机或启动模拟器
   - 系统会尝试连接到指定地址的无人机，支持自动重试
   - 连接成功后，系统会初始化飞行状态和参数

3. **目标检测与跟踪**:
   - 视频模块实时处理摄像头输入
   - 识别目标物体并计算相对位置
   - 将目标信息传递给导航模块

4. **路径规划与避障**:
   - 基于当前位置和目标位置生成初始路径
   - 检测环境中的障碍物（用户添加或传感器探测）
   - 使用RRT算法规划绕过障碍物的路径
   - 对生成的路径进行平滑处理

5. **导航控制**:
   - 系统支持三种导航模式：
     - 主动避障：实时规划绕过障碍物的路径
     - 地理围栏：限制无人机在指定区域内飞行
     - 直接飞行：直接飞向目标点（不考虑障碍物）
   - 根据规划的路径发送控制命令给无人机

6. **状态监控与反馈**:
   - 实时显示无人机状态（位置、电池、连接质量等）
   - 显示规划路径和障碍物位置
   - 记录系统日志和飞行数据

## 安装要求

- Python 3.8+
- DroneKit和MAVLink
- OpenCV
- 其他依赖见requirements.txt

## 使用方法

1. 安装依赖：
```
pip install -r requirements.txt
```

2. 启动系统：
```
python main.py [选项]
```

### 常用命令行选项

- `--sim`：使用模拟器模式
- `--connect <连接字符串>`：指定连接到的无人机或模拟器地址
- `--enable-obstacle-avoidance`：启用避障功能

## 障碍物管理

系统提供以下障碍物管理功能：

1. **障碍物添加**：
   - 通过GUI界面添加障碍物
   - 通过视频画面点击添加障碍物
   - 支持设置障碍物类型、半径等参数

2. **障碍物编辑**：
   - 编辑现有障碍物的位置、尺寸和类型
   - 直观显示障碍物信息

3. **障碍物移除**：
   - 移除单个障碍物
   - 清除所有障碍物

## 路径规划

系统支持以下路径规划功能：

1. **自动路径规划**：
   - 设置目标位置后自动规划最佳路径
   - 考虑所有已知障碍物，保证飞行安全

2. **路径显示**：
   - 在视频画面中直观显示规划路径
   - 显示起点、终点和当前目标点

3. **路径跟踪**：
   - 自动跟踪规划好的路径
   - 实时显示当前跟踪状态和目标点
